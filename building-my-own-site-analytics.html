<!DOCTYPE html>

<html class="" id="baz" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
      <![endif]-->
<title>Building my own web analytics - John Mathews</title>
<meta content="Building my own web analytics -  John Mathews " name="title"/>
<meta content="John Mathews" name="author"/>
<meta content=" cloud-functions,data " name="keywords"/>
<meta content=" I’ve built a simple client-side website analytics tool for this site, you can see it at /analytics. It has the following metrics: Page views per day, Unique IP addresses per day Views per page per day. This article eventually made it to the front page of Hacker News, which resulted in a lot of extra traffic and an opportunity to see how the tool performed under a much heavier load. I wrote about the affects of this and subsequent design changes here. I compare the different results from... " name="description"/>
<meta content="@johnmathews" name="twitter:creator"/>
<meta content="https://johnmathews.eu" name="twitter:domain"/>
<meta content="Building my own web analytics" property="twitter:title"/>
<meta content=" I’ve built a simple client-side website analytics tool for this site, you can see it at /analytics. It has the following metrics: Page views per day, Unique IP addresses per day Views per page per day. This article eventually made it to the front page of Hacker News, which resulted in a lot of extra traffic and an opportunity to see how the tool performed under a much heavier load. I wrote about the affects of this and subsequent design changes here. I compare the different results from... " name="twitter:description"/>
<meta content="https://johnmathews.eu/building-my-own-site-analytics.html" property="twitter:url"/>
<meta content="https://johnmathews.eu/
" name="twitter:image"/>
<meta content="  summary  " property="twitter:card"/>
<meta content=" article " property="og:type"/>
<meta content="Building my own web analytics" property="og:title"/>
<meta content=" I’ve built a simple client-side website analytics tool for this site, you can see it at /analytics. It has the following metrics: Page views per day, Unique IP addresses per day Views per page per day. This article eventually made it to the front page of Hacker News, which resulted in a lot of extra traffic and an opportunity to see how the tool performed under a much heavier load. I wrote about the affects of this and subsequent design changes here. I compare the different results from... " property="og:description"/>
<meta content="https://johnmathews.eu/building-my-own-site-analytics.html" property="og:url"/>
<meta content="https://johnmathews.eu/
" property="og:image"/>
<link href="https://johnmathews.eu/feeds/all.atom.xml" rel="alternate" title="John Mathews - all articles" type="application/atom+xml"/>
<link href="https://johnmathews.eu/feeds/technical.atom.xml" rel="alternate" title="John Mathews - technical articles" type="application/atom+xml"/>
<link href="https://johnmathews.eu/feeds/non-technical.atom.xml" rel="alternate" title="John Mathews - non-Technical articles" type="application/atom+xml"/>
<link href="https://johnmathews.eu/feeds/snippet.atom.xml" rel="alternate" title="John Mathews - snippet articles" type="application/atom+xml"/>
<script crossorigin="anonymous" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" rel="stylesheet"/>
<link href="https://fonts.gstatic.com" rel="preconnect"/>
<link async="" href="https://fonts.googleapis.com/css2?family=Cardo&amp;display=swap" rel="stylesheet"/>
<link async="" href="https://fonts.googleapis.com/css2?family=Anonymous+Pro&amp;display=swap" rel="stylesheet"/>
<script>
          window.ga = window.ga || function () {
            (ga.q = ga.q || []).push(arguments);
          };
          ga.l = +new Date();
          ga("create", "UA-82253540-1", "auto");
          ga("send", "pageview");
        </script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<link href="https://johnmathews.eu/extra/favicon.png" rel="icon"/>
<link href="https://johnmathews.eu/theme/css/styles.css" rel="stylesheet"/>
<link href="https://johnmathews.eu/theme/css/pygment-light.css" id="PygmentCSS" media="print" onload="this.media='all'" rel="stylesheet"/>
<script>
        if (localStorage.getItem('theme') === 'dark') {
          document.getElementById('baz').classList.add('dark')
        }
      </script>
<!-- Cloudflare Web Analytics -->
<script data-cf-beacon='{"token": "514cf3cd5e214097b029daa10cd1b209"}' defer="" src="https://static.cloudflareinsights.com/beacon.min.js"></script>
<!-- End Cloudflare Web Analytics -->
</head>
<body class="dark:bg-gray-900">
<a class="pt-20 mt-20" name="top"></a>
<nav class="md:fixed z-50 top-0 w-screen flex flex-row justify-between pt-2 text-xl bg-white dark:bg-gray-900" id="navbar" style="transition: top 0.3s ease-in-out;">
<div class="text-bold pr-3 hidden md:flex md:flex-grow xl:hidden">
<div class="mt-10 md:mt-0 flex-grow justify-between">
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1" href="https://johnmathews.eu/blog.html">Blog</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1" href="https://johnmathews.eu/snippets.html">Snippets</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1" href="https://johnmathews.eu/categories.html">Categories</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1" href="https://johnmathews.eu/about.html">About</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1" href="https://johnmathews.eu/portfolio.html">Portfolio</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1" href="https://johnmathews.eu/experience.html">Experience</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1" href="https://johnmathews.eu/book-notes.html">Books</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1" href="https://johnmathews.eu/analytics.html">Analytics</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1" href="javaScript:;" id="searchButton2">Search</a>
</div>
<div class="flex-none justify-end px-2 pt-2">
<button aria-label="themeToggle" class="inline-block theme-toggle" id="modeSwitcher1">
<div class="day modeIcon hidden">
<i class="mb-2 pb-2 far fa-lightbulb fa-lg"></i>
</div>
<div class="night modeIcon">
<i class="mb-2 pb-2 far fa-moon fa-lg"></i>
</div>
</button>
<button aria-label="Category chooser" class="catChooser hidden md:mt-0 ml-5 md:pl-0">
<i class="mb-2 pb-2 fas fa-paw fa-lg"></i>
</button>
</div>
</div>
<div class="flex-none md:hidden block md:inline-block">
<button aria-label="Menu" class="mx-2 my-1" id="hamburger">
<div class="toggle"><i class="fas fa-bars fa-lg"></i></div>
<div class="hidden toggle"><i class="fas fa-times fa-lg"></i></div>
</button>
</div>
</nav>
<div class="toggle hidden w-screen flex flex-col text-left mt-5">
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1 text-2xl" href="https://johnmathews.eu/blog.html">Blog</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1 text-2xl" href="https://johnmathews.eu/snippets.html">Snippets</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1 text-2xl" href="https://johnmathews.eu/about.html">About</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1 text-2xl" href="https://johnmathews.eu/categories.html">Categories</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1 text-2xl" href="https://johnmathews.eu/portfolio.html">Portfolio</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1 text-2xl" href="https://johnmathews.eu/experience.html">Experience</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1 text-2xl" href="https://johnmathews.eu/book-notes.html">Books</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1 text-2xl" href="https://johnmathews.eu/analytics.html">Analytics</a>
<a class="text-gray-700 dark:text-gray-200 hover:underline font-semibold px-3 py-1 text-2xl" href="javaScript:;" id="searchButton3">Search</a>
<div class="px-3 pt-3 flex flex-row">
<button aria-label="themeToggle" class="mx-1 theme-toggle" id="modeSwitcher3">
<div class="day modeIcon">
<i class="far fa-lightbulb fa-2x"></i>
</div>
<div class="night modeIcon hidden">
<i class="far fa-moon fa-2x"></i>
</div>
</button>
<button aria-label="Category chooser" class="catChooser hidden ml-5">
<i class="fas fa-paw fa-2x"></i>
</button>
</div>
</div>
<main class="lg:mt-10 lg:pt-5 mx-3 lg:mx-auto lg:w-5/6">
<div class="hidden fixed z-10 inset-0 overflow-y-auto" id="catModal">
<div class="flex items-end justify-center text-center min-h-screen pb-80 px-4 md:block md:p-0">
<div aria-hidden="true" class="fixed inset-0 transition-opacity">
<div class="absolute inset-0 bg-gray-500 opacity-75"></div>
</div>
<span aria-hidden="true" class="hidden sm:inline-block sm:align-middle md:h-screen">​</span>
<div aria-labelledby="modal-headline" aria-modal="true" class="inline-block align-bottom bg-white border-4 border-gray-50 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle" role="dialog">
<div class="bg-gradient-to-t from-blue-300 to-yellow-300 px-5 py-5">
<div class="text-center">
<h3 class="text-2xl font-medium leading-8 md:leading-6 pb-2 text-gray-700" id="modal-headlinemd">
                  Which categories do you want to see?
                </h3>
<hr class="border -ml-6 -mr-6 border-blue-500 border-4 mt-2 mb-4"/>
<div class="flex items-center flex-row space-x-4 justify-center text-base my-auto text-gray-700" id="" role="group">
<button class="text-xl py-1 px-2 py-0 mx-0 bg-none rounded-xl hover:text-gray-50 hover:bg-yellow-500 border-0 outline-none focus:shadow-outline" id="chooseBoth">All</button>
<button class="text-xl py-1 px-2 bg-none rounded-xl hover:text-gray-50 hover:bg-yellow-500 outline-none focus:shadow-outline active:bg-red-500" id="chooseTechnical">Technical</button>
<button class="text-xl py-1 px-2 bg-none rounded-xl hover:text-gray-50 hover:bg-yellow-500 outline-none focus:shadow-outline" id="chooseNonTechnical">Non-Technical</button>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="hidden fixed z-10 inset-0 overflow-y-auto" id="keyboardShortcuts">
<div class="flex items-end justify-center text-center min-h-screen pb-80 px-4 md:block md:p-0">
<div aria-hidden="true" class="fixed inset-0 transition-opacity">
<div class="absolute inset-0 bg-gray-500 opacity-75"></div>
</div>
<span aria-hidden="true" class="hidden sm:inline-block sm:align-middle md:h-screen">​</span>
<div aria-labelledby="modal-headline" aria-modal="true" class="w-5/6 inline-block align-bottom bg-white border-4 border-gray-50 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle" role="dialog">
<div class="px-5 py-5">
<div class="">
<h3 class="text-2xl font-medium leading-8 md:leading-6 pb-2 text-gray-700" id="modal-headlinemd">
                 Keyboard Shortcuts:
                </h3>
<hr class="mb-5"/>
<div class="text-base text-gray-700" id="" role="group">
<div class="markdown">
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 grid-flow-row text-black text-base leading-loose">
<div class="pb-1"><code>?</code><span class="ml-2">toggle shortcut descriptions</span></div>
<div class="pb-1"><code>/</code><span class="ml-2"> search</span></div>
<div class="pb-1"><code>j</code><span class="ml-2"> scroll down</span></div>
<div class="pb-1"><code>k</code><span class="ml-2"> scroll up</span></div>
<div class="pb-1 -ml-2"><code>tt</code><span class="ml-2"> toggle dark theme</span></div>
<div class="pb-1 -ml-2"><code>gi</code><span class="ml-2"> go to blog index page</span></div>
<div class="pb-1 -ml-2"><code>gn</code><span class="ml-2"> go to next article</span></div>
<div class="pb-1 -ml-2"><code>gp</code><span class="ml-2"> go to previous article</span></div>
<div class="pb-1 -ml-2"><code>gf</code><span class="ml-2"> go forwards</span></div>
<div class="pb-1 -ml-2"><code>gb</code><span class="ml-2"> go to previous page</span></div>
<div class="pb-1 -ml-2"><code>gc</code><span class="ml-2"> go to categories page</span></div>
<div class="pb-1 -ml-2"><code>go</code><span class="ml-2"> go to article's category page</span></div>
<div class="pb-1 -ml-2"><code>ga</code><span class="ml-2"> go to about page</span></div>
<div class="pb-1 -ml-2"><code>ge</code><span class="ml-2"> go to experience page</span></div>
<div class="pb-1 -ml-2"><code>gr</code><span class="ml-2"> go to portfolio page</span></div>
<div class="pb-1 -ml-2"><code>gk</code><span class="ml-2"> go to books page</span></div>
<div class="pb-1 -ml-2"><code>gm</code><span class="ml-2"> go to analytics (metrics) page</span></div>
<div class="pb-1 -ml-2"><code>gs</code><span class="ml-2"> go to snippets page</span></div>
<div class="pb-1 -ml-2"><code>gl</code><span class="ml-2"> go to landing page</span></div>
<div class="pb-1 -ml-2"><code>vt</code><span class="ml-2"> only show technical articles on blog index page</span></div>
<div class="pb-1 -ml-2"><code>vn</code><span class="ml-2"> only show non-technical articles on blog index page</span></div>
<div class="pb-1 -ml-2"><code>va</code><span class="ml-2"> show articles from all categories on blog index page</span></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="hidden fixed z-50 inset-0 overflow-y-auto" id="fuseModal">
<div class="flex items-start justify-center text-center min-h-screen pb-80 px-4 md:block md:p-0" id="searchModalBackground">
<div aria-hidden="true" class="fixed inset-0 transition-opacity">
<div class="absolute inset-0 bg-gray-500 opacity-75"></div>
</div>
<div class="absolute inset-x-0 w-screen px-3">
<div aria-labelledby="modal-headline" aria-modal="true" class="w-full md:w-10/12 lg:w-8/12 mt-20 inline-block align-bottom bg-white border-4 border-gray-50 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:align-middle" role="dialog">
<div class="py-1 px-1">
<input class="mt-5 mb-3 px-3 mb-5 w-full text-gray-800 text-xl font-semibold border-2 border-gray-200 rounded-lg" id="searchBox" style="outline:0;" type="text"/>
<div class="hidden lg:inline-flex flex">
<div class="width-12 mx-1 px-2 text-gray-500 border border-gray-300 rounded-lg">
                    /
                  </div>
                  or
                  <div class="width-12 mx-1 px-2 text-gray-500 border border-gray-300 rounded-lg" id="macOrPc">
                    cmd-K
                  </div>
</div>
<ul class="results text-lg text-bold text-gray-600" id="searchResults">
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="mx-auto w-full">
<div class="flex flex-row">
<div class="hidden xl:inline xl:w-32">
<div class="w-32">
<div class="mt-5 2xl:mt-20 fixed flex flex-col">
<div class="lg:w-32">
<div>
<a class="my-2 prose prose-xl leading-8 text-gray-700 dark:text-gray-200 hover:underline font-semibold block md:inline-block" href="https://johnmathews.eu/index.html"><i class="far fa-md fa-star"></i></a>
</div>
<div>
<a class="text-lg my-2 text-gray-700 dark:text-gray-200 hover:underline font-semibold block md:inline-block" href="https://johnmathews.eu/blog.html">Blog</a>
</div>
<a class="text-lg my-2 text-gray-700 dark:text-gray-200 hover:underline font-semibold block md:inline-block" href="https://johnmathews.eu/categories.html">Categories</a>
<a class="text-lg my-2 text-gray-700 dark:text-gray-200 hover:underline font-semibold block md:inline-block" href="https://johnmathews.eu/snippets.html">Snippets</a>
<a class="text-lg my-2 text-gray-700 dark:text-gray-200 hover:underline font-semibold block md:inline-block" href="https://johnmathews.eu/about.html">About</a>
<a class="text-lg my-2 text-gray-700 dark:text-gray-200 hover:underline font-semibold block md:inline-block" href="https://johnmathews.eu/portfolio.html">Portfolio</a>
<a class="text-lg my-2 text-gray-700 dark:text-gray-200 hover:underline font-semibold block md:inline-block" href="https://johnmathews.eu/experience.html">Experience</a>
<a class="text-lg my-2 text-gray-700 dark:text-gray-200 hover:underline font-semibold block md:inline-block" href="https://johnmathews.eu/book-notes.html">Books</a>
<a class="text-lg my-2 text-gray-700 dark:text-gray-200 hover:underline font-semibold block md:inline-block" href="https://johnmathews.eu/analytics.html">Analytics</a>
<div id="searchButton"><a class="text-lg my-2 text-gray-700 dark:text-gray-200 hover:underline font-semibold block md:inline-block" href="javaScript:;">Search</a></div>
<div class="flex my-2">
<button aria-label="themeToggle" class="md:pl-0 my-2 theme-toggle" id="modeSwitcher2">
<div class="day modeIcon">
<i class="far fa-lightbulb fa-lg"></i>
</div>
<div class="night modeIcon hidden">
<i class="far fa-moon fa-lg"></i>
</div>
</button>
</div>
<div class="-mr-10 border-t-4 border-double border-gray-800 dark:border-gray-100 mt-10">
</div>
<div class="pt-10 font-serif text-lg text-gray-700 font-bold dark:text-gray-300">
    Published: <br/> June 2021
  </div>
<div class="pt-5 font-serif text-lg text-gray-700 font-bold dark:text-gray-300 w-36">
 Categories: 
    <div>
<a class="hover:underline" href="https://johnmathews.eu/category/technical/web.html">Web</a>
<span class="-ml-1">,<span> <a class="hover:underline" href="https://johnmathews.eu/category/.html"></a>
</span></span></div>
</div>
</div>
</div>
</div>
</div>
<div class="min-h-screen w-full xl:w-5/6 xl:ml-20" id="contentParent">
<div class="mx-3 xl:ml-20 my-4 technical" id="articleParent">
<div class="mt-20 md:mt-40 lg:mt-20 xl:mt-8 2xl:mt-20">
<div class="leading-tight text-left font-serif lg:-mr-30 xl:-mr-40 text-5xl md:text-6xl lg:text-8xl 2xl:text-9xl font-semibold lg:font-normal dark:text-gray-200 break-words md:break-all" style="word-break: unset; white-space: wrap;">
          Building my own web analytics
      </div>
<div class="lg:hidden mt-10 md:mt-20 text-lg font-serif font-light text-gray-600 dark:text-gray-300">
        June 2021
      </div>
</div>
<div class="mt-10 lg:mt-20 2xl:mt-40 2xl:mb-10 border-b-0 border-gray-600 dark:border-gray-200 border-double">
</div>
<main class="lg:w-4/6">
<article class="">
<div class="markdown">
<p>I’ve built a simple client-side website analytics tool for this site, you can see it at
<a href="https://johnmathews.eu/analytics.html">/analytics</a>. It has the following metrics:</p>
<ul>
<li>Page views per day,</li>
<li>Unique <span class="caps">IP</span> addresses per day</li>
<li>Views per page per day.</li>
</ul>
<p>This article eventually made it to the front page of <a href="https://news.ycombinator.com/item?id=27686873">Hacker News</a>, which resulted
in a lot of extra traffic and an opportunity to see how the tool performed under a
much heavier load. I wrote about the affects of this and subsequent design changes <a href="https://johnmathews.eu/load-testing-web-analytics-tool.html">here</a>.</p>
<p>I compare the different results from CloudFlare Analytics, CloudFlare Web Analytics and my
own tool in this follow-up <a href="https://johnmathews.eu/validating-cloudflare-analytics.html">article</a>.</p>
<h2 id="motivation">Motivation</h2>
<h3>Google Analytics</h3>
<p>Google Analytics felt like overkill. It has so many data-points that the
useful metrics are obscured. I also like this site to load quickly
and <span class="caps">GA</span> makes it slower.</p>
<h3>CloudFlare Analytics</h3>
<p>I’ve also tried CloudFlare Analytics. It’s a lot simpler than <span class="caps">GA</span> and better
suits my use case, but I don’t think its accurate.</p>
<h2 id="design-considerations">Design Considerations</h2>
<p>The analytics should be easy to access and easy to understand<sup id="sf-building-my-own-site-analytics-1-back"><a class="simple-footnote" href="#sf-building-my-own-site-analytics-1" title="In Google Analytics it can be fun clicking around on all the things and seeing lots of options, but its not really useful once the novelty has worn off.">1</a></sup>.</p>
<p>I know from my work visualizing data and building dashboards that the metrics
presented will alter the users perception of the underlying reality.</p>
<p>The way that someone thinks about their impact on a business, the value they’ve
produced, or the dynamics of the underlying system (a product’s quality, site
performance, growth, etc) is influenced by the design decisions I make, such as
which metrics are available, how easy they are to access, or which metrics are
above the fold.</p>
<p>If I present a particular metric as if its important, it will be difficult
for someone who uses the dashboard to resist this implied message. They’ll eventually
consider the metric as a Key Indicator of some kind.</p>
<p>For these reasons I wanted to see only the most important metrics about my
website, and I wanted to see them in a simple way without distraction.</p>
<p>The only metrics I’m interested in are:</p>
<ol>
<li>How many people are reading my site</li>
<li>What are they reading</li>
<li>How much are they reading.</li>
</ol>
<p>I’d like to be able to infer whether I have a few people who read a lot, or a lot of people
who read a little. (Or, as is the case, a few people who read a little.)</p>
<h2 id="method">Method</h2>
<h3>Motivation</h3>
<p>The main reason for making my own analytics tool it because its a fun challenge
with an obvious and useful result. Building it required connecting a few technologies -
Serverless Computing (Cloud Functions on <span class="caps">GCP</span>), NoSQL databases (DataStore),
JavaScript, <span class="caps">HTTP</span> headers.</p>
<h3>Assumptions</h3>
<p>I’m assuming that unique <span class="caps">IP</span> addresses is a good enough proxy for unique readers, even
though I’m not considering crawlers, bots, or <span class="caps">RSS</span> subscribers<sup id="sf-building-my-own-site-analytics-2-back"><a class="simple-footnote" href="#sf-building-my-own-site-analytics-2" title="I think this might be quite wrong, but I don’t know why.">2</a></sup> .</p>
<h3>Technique</h3>
<p>The analytics “engine” works by consuming a request that is sent by the client
each time a page is loaded. The request is parsed by a Cloud Function on <span class="caps">GCP</span>
which extracts the page <span class="caps">URL</span> and the <span class="caps">IP</span> address. This is then recorded in a
DataStore database along with the current date and time.</p>
<p>Viewing the analytics is as simple (and as complicated) as making a request to
the database, parsing the data and visualizing it conveniently. For example,
group the data by days and count the distinct <span class="caps">IP</span> Addresses to figure out how
many people are visiting each day. This is achieved by making a request to
another Cloud Function that returns a response with a <span class="caps">JSON</span> payload.</p>
<p>It’s not a perfect solution, there are edge cases I’m not considering. I expect
it to be mostly right and good enough for my purposes. It didn’t take much
effort and it was a fun mini project. The hardest part was figuring out
<code>chart.js</code>, the slowest part was iterating on the Cloud Functions.</p>
<h3>Mocking Cloud Functions</h3>
<p>I haven’t figured out how to easily test cloud functions locally - it would
require setting up a NoSQL database and mocking Flask requests and responses.
Instead of doing that, I watched Peaky Blinders for a couple of minutes whilst
each new version of the Cloud Function was deploying.</p>
<h3>Improvements</h3>
<p>Eventually I’ll want to group the metrics by week or month I expect. It’ll be a
good way of learning and playing with cloud technologies and JavaScript.</p>
<p>Unless someone decides to spam the site, I expect the costs to be less than
€1/month. This site is hosted using CloudFlare, so I suppose I could setup some
page rules to prevent malicious traffic<sup id="sf-building-my-own-site-analytics-3-back"><a class="simple-footnote" href="#sf-building-my-own-site-analytics-3" title="The page is now rate limited to 5 requests per minute per IP address.">3</a></sup> .</p>
<h2 id="tasks-for-later">Tasks for later</h2>
<ul class="checklist">
<li><input checked="" disabled="" type="checkbox"/>  Make <code>/analytics.html</code> load faster - latency is caused by the Cloud Function initialising. Short of paying actual money for always-on resources I can’t see a way to reduce this. However it’s only an issue if you are the first person to view the page in the last ~10 minutes - this <a href="https://mikhail.io/serverless/coldstarts/gcp/">blog post</a> explains whj.</li>
<li><input checked="" disabled="" type="checkbox"/>  Add loading spinners - I used the same snippets as in my <a href="https://johnmathews.eu/portfolio-image-recognition.html">Machine Vision demo</a>.</li>
<li><input disabled="" type="checkbox"/>  Group data by weeks or months as well as day.</li>
<li><input disabled="" type="checkbox"/>  Identify bots and search engines - the analytics requires JavaScript to be running so I think some types of non-human activity is already filtered. How can I do this?</li>
<li><input disabled="" type="checkbox"/>  Aggregate the data (once per day) in a Cloud Function instead of repeatedly in the browser.</li>
<li><input disabled="" type="checkbox"/>  Understand why the DataStore <span class="caps">API</span> is called multiple times for a single fetch.</li>
</ul>
<h2 id="questions">Questions</h2>
<ol>
<li>I’d be interested to know if there is a way to track <span class="caps">RSS</span> subscribers. I know
    that the usual method is to inspect server logs, but this site is hosted on
    GitHub pages so I don’t think this is possible.</li>
<li>To what extent does requiring JavaScript in order to log a page view filter out bots and crawlers?</li>
<li>
<p>I’ve used the <code>chart.js</code> library because its reasonably fast and lightweight. My
    preferred library would be <code>Plotly</code> if it could be responsive and fast even
    if there are &gt;10 charts to render.</p>
<p>Has <code>plotly.js</code> improved recently to the point where it wouldn’t cause a browser to lag if multiple plots are being rendered?</p>
</li>
</ol>
<p>Finally, it occurs to me that I could make an analytics widget for my desktop
using <a href="https://tracesof.net/uebersicht/">Übersicht</a>. It could show page views
for the current day perhaps. I’ve made a couple of widgets before
[<a href="http://tracesof.net/uebersicht-widgets/#time_since">1</a>,
<a href="http://tracesof.net/uebersicht-widgets/#time_until">2</a>] which were written in
CoffeeScript, but the newer widgets are written in React, so I guess this is an
opportunity to learn<sup id="sf-building-my-own-site-analytics-4-back"><a class="simple-footnote" href="#sf-building-my-own-site-analytics-4" title="Done! My desktop now looks like this: ">4</a></sup> .</p>
<p>Writing the “Time Since” (my daughters birth) and “Time Until” (my next
accounting exam<sup id="sf-building-my-own-site-analytics-5-back"><a class="simple-footnote" href="#sf-building-my-own-site-analytics-5" title="I failed the exam because I’d been working on Ry’s Git Tutorial instead.">5</a></sup> ) widgets were my
first ever taste  of <span class="caps">CSS</span>, <span class="caps">HTML</span> and JavaScript. The first ever article on
this blog was about the “Time Since” widget. CoffeeScript, and Ubersicht were
just about simple enough for me to learn by trial and error, copying someone
else’s code and changing it bit by bit until I had what I want.</p>
<p><a href="https://johnmathews.eu/analytics.html"><strong>Site Analytics</strong></a></p><ol class="simple-footnotes"><li id="sf-building-my-own-site-analytics-1">In Google
Analytics it can be fun clicking around on all the things and seeing lots of
options, but its not really useful once the novelty has worn off. <a class="simple-footnote-back" href="#sf-building-my-own-site-analytics-1-back">↩</a></li><li id="sf-building-my-own-site-analytics-2">I think this
might be quite wrong, but I don’t know why. <a class="simple-footnote-back" href="#sf-building-my-own-site-analytics-2-back">↩</a></li><li id="sf-building-my-own-site-analytics-3">The page is now rate limited to 5
requests per minute per <span class="caps">IP</span> address. <a class="simple-footnote-back" href="#sf-building-my-own-site-analytics-3-back">↩</a></li><li id="sf-building-my-own-site-analytics-4">Done! My desktop now looks like this: <img alt="Dekstop widgets" class="image-process-article-inline-image" loading="lazy" sizes="(min-width: 1536x) 1020px, (min-width: 1280px) 850px, (min-width: 1024px) 800px, (min-width: 768px) 800px, (min-width: 640px) 800px, 100vw" src="https://johnmathews.eu/images/derivatives/article-inline-image/800w/widgets.png" srcset="https://johnmathews.eu/images/derivatives/article-inline-image/300w/widgets.png 300w, https://johnmathews.eu/images/derivatives/article-inline-image/600w/widgets.png 600w, https://johnmathews.eu/images/derivatives/article-inline-image/800w/widgets.png 800w, https://johnmathews.eu/images/derivatives/article-inline-image/1600w/widgets.png 1600w"/> <a class="simple-footnote-back" href="#sf-building-my-own-site-analytics-4-back">↩</a></li><li id="sf-building-my-own-site-analytics-5">I failed the exam because I’d been working on
<a href="https://johnmathews.eu/rys-git-tutorial.html">Ry’s Git Tutorial</a> instead. <a class="simple-footnote-back" href="#sf-building-my-own-site-analytics-5-back">↩</a></li></ol>
</div>
</article>
</main>
<div class="mt-20 mb-10 text-lg dark:text-gray-200">
<div class="hidden mt-2 flex flex-row font-serif text-lg text-gray-700 font-bold dark:text-gray-300">
        Other articles in:
          <a class="hover:underline ml-1 text-gray-600 dark:text-gray-300 font-serif text-lg font-bold" href="https://johnmathews.eu/category/technical/web.html" id="otherArticlesInCategory"> Web</a>
          , 
          <a class="hover:underline ml-1 text-gray-600 dark:text-gray-300 font-serif text-lg font-bold" href="https://johnmathews.eu/category/.html" id="otherArticlesInCategory"> </a>
</div>
</div>
</div>
</div>
</div>
</div>
</main>
<footer class="footer w-5/6 mx-auto border-t-2 border-single border-gray-200 mt-10 py-3">
<div class="text-center font-serif text-lg text-gray-700 dark:text-gray-200">
<a class="px-3" href="#top">Back to top</a> |
        <a class="px-3" href="https://johnmathews.eu/blog.html">Blog Posts</a> |
        <a class="px-3" href="https://johnmathews.eu/categories.html">Categories</a> |
        <a class="px-3" href="https://johnmathews.eu/feeds/all.atom.xml">RSS</a> |
        <a class="px-3" href="JavaScript:void(0)" id="viewShortcuts">Shortcuts</a> |
        <a class="px-3" href="https://twitter.com/johnmathews">Twitter</a> |
        <a class="px-3" href="https://johnmathews.eu/tags.html">Tags</a>
</div>
</footer>
<script>
        const light = "https://johnmathews.eu/theme/css/pygment-light.css"
        const dark = "https://johnmathews.eu/theme/css/pygment-dark.css"
        const indexURL = 'https://johnmathews.eu/fuse.html'
        const siteURL = 'https://johnmathews.eu'

        // show category options window when cat icon is clicked
        $( ".catChooser" ).click(function() {
              $('#catModal').removeClass('hidden');
        });


      </script>
<script crossorigin="anonymous" rel="prefetch" src="https://johnmathews.eu/theme/js/categoryChooser.js" type="module"></script>
<script crossorigin="anonymous" rel="prefetch" src="https://johnmathews.eu/theme/js/navbar.js" type="text/javascript"></script>
<script crossorigin="anonymous" rel="prefetch" src="https://johnmathews.eu/theme/js/fuseSearch.js" type="module"></script>
<script crossorigin="anonymous" rel="prefetch" src="https://johnmathews.eu/theme/js/keyboard-shortcuts.js" type="module"></script>
<script crossorigin="anonymous" rel="prefetch" src="https://johnmathews.eu/theme/js/themeChooser.js" type="module"></script>
<script>
        // toggle cat modal view
        $( "#catModal" ).click(function() {
                  console.log('flag1')
                  $('#catModal').addClass('hidden');
                });
      </script>
<script>
        if (navigator.userAgent.indexOf('Mac OS X') != -1) {
          $("#macOrPc").html("&#8984;K");
        } else {
          $("#macOrPc").html("Cmd-K");
        }
      </script>
<script>
            result = navigator.sendBeacon('https://us-central1-johnmathews-website.cloudfunctions.net/page_view_logger?path='+window.location.pathname);
        </script>
<script>
    const technical = $( "#articleParent" ).hasClass('technical');
    const nonTechnical = $( "#articleParent" ).hasClass('nonTechnical');

    // if user preference for article category has been set and is contradicted by currenct article, update it
    if (localStorage.getItem('categoryChoice') === "technical") {
      if (nonTechnical) {
        window.localStorage.setItem('categoryChoice', 'all');
      };
    } else if (localStorage.getItem('categoryChoice') === "nonTechnical") {
      if (technical) {
        window.localStorage.setItem('categoryChoice', 'all');
      };
    } else if (localStorage.getItem('categoryChoice') === "all") {
      // do nothing
    } else {
      // if user preference for article category hasn't been set, assign it using article type
      if (technical) {
        window.localStorage.setItem('categoryChoice', 'technical');
      } else if (nonTechnical) {
        window.localStorage.setItem('categoryChoice', 'nonTechnical');
      };
    }
  </script>
</body>
</html>